{% load get_dict %}

<h2>Assign Monthly Fee Dues (Bulk)</h2>

<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="filter_students">Filter Students</button>
</form>

{% if students %}
<form method="post">
    {% csrf_token %}
    {% if already_posted %}
    <p style="color: red;"><strong>⚠ Fees for this month have already been posted for at least one student. Editing will update existing records.</strong></p>
    {% endif %}

    <p style="color: darkblue;">
        ℹ️ The amounts below are pre-filled from the previous month (if available), or from the assigned fee plan.
        You can override them before clicking <strong>Post Fees</strong>.
    </p>

    <input type="hidden" name="post_fees" value="1">
    <input type="hidden" name="month" value="{{ selected_month|date:'Y-m' }}">
    <input type="hidden" name="academic_year" value="{{ selected_year_id }}">
    <input type="hidden" name="class_enrolled" value="{{ selected_class_id }}">

    <table border="1">
        <thead>
            <tr>
                <th>Select</th>
                <th>Student Name</th>
                {% for fee_type in fee_types %}
                    <th>{{ fee_type.name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td><input type="checkbox" name="student_ids" value="{{ student.student.id }}" checked></td>
                <td>{{ student.student.full_name }}</td>
                {% for fee_type in fee_types %}
                <td>
                    <input type="number" step="0.01"
                           name="amount_{{ student.student.id }}_{{ fee_type.id }}"
                           value="{{ student.student.previous_fee_keys|get_item:fee_type.id }}"
                           placeholder="₹">
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit">Post Fees</button>
</form>
{% endif %}


<a href="{% url 'fees_home' %}">⬅ Back to Fees Home</a>
